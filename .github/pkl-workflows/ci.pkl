amends "https://cdn.jsdelivr.net/gh/StefMa/pkl-gha@77880b64db1f3bf24b31a359311a6f7ef64bffaa/Workflow.pkl"
import "https://cdn.jsdelivr.net/gh/StefMa/pkl-gha@77880b64db1f3bf24b31a359311a6f7ef64bffaa/Action.pkl"

import "modules/mise.pkl"

name = "CI"

on {
  push {
    branches {
      "main"
    }
  }
  workflow_dispatch {}
}

concurrency = new Concurrency {
  group = "ci"
  `cancel-in-progress` = true
}

jobs {
  ["test"] = new {
    `runs-on` = "ubuntu-24.04"
    env = new {
      ["MIX_ENV"] = "test"
    }
    steps {
      Action.checkout
      (mise.Mise) {
        miseToml = """
          [settings]
          enable_tools = ["elixir", "erlang"]
          """
      }
      (Action.cache) {
      name = "Elixir Deps cache"
      id = "elixir-deps-cache"
      path = """
        deps
        _build
        .mix/archives/
        """
      key = "elixir-build-${{hashFiles('.mise.lock')}}-${{hashFiles('mix.lock')}}"
      restoreKeys = "elixir-build-${{hashFiles('.mise.lock')}}-"
      }
      new {
        name = "Install Elixir Deps"
        run = """
          mix local.hex --force --if-missing
          mix deps.get
          """
      }
      new {
        name = "Test"
        run = """
          mix compile --warnings-on-errors
          mix test
          """
      }
    }
  }
}
