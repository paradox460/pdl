amends "https://cdn.jsdelivr.net/gh/StefMa/pkl-gha@77880b64db1f3bf24b31a359311a6f7ef64bffaa/Workflow.pkl"
import "https://cdn.jsdelivr.net/gh/StefMa/pkl-gha@77880b64db1f3bf24b31a359311a6f7ef64bffaa/Action.pkl"

import "https://cdn.jsdelivr.net/gh/paradox460/shared-pkl@0c33020a8e18437752765a0483aeefbf3bb03fe5/gha/mise.pkl"
import "https://cdn.jsdelivr.net/gh/paradox460/shared-pkl@0c33020a8e18437752765a0483aeefbf3bb03fe5/gha/elixir.pkl"

name = "CI"

on {
  push {
    branches {
      "main"
    }
  }
  workflow_dispatch {}
}

concurrency = new Concurrency {
  group = "ci"
  `cancel-in-progress` = true
}

jobs {
  ["test"] = new {
    `runs-on` = "ubuntu-24.04"
    env = new {
      ["MIX_ENV"] = "test"
    }
    steps {
      Action.checkout
      (mise.Mise) {
        miseToml = """
          [settings]
          enable_tools = ["elixir", "erlang"]
          """
      }
      ...elixir.elixir
      new {
        name = "Test"
        run = """
          mix compile --warnings-on-errors
          mix test
          """
      }
    }
  }
}
